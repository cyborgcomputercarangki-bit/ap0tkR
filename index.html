<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Apotek Sejahtera - Pro POS Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');
        
        :root {
            --royal-blue: #1e40af;
            --soft-blue: #eff6ff;
            --luxury-white: #ffffff;
            --border-color: #e5e7eb;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #f8fafc; 
            color: #1e293b;
        }

        .glass { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(15px); 
            border-bottom: 1px solid var(--border-color);
        }
        
        .nav-btn { 
            font-weight: 700; color: #94a3b8; transition: all 0.3s ease; 
            border-bottom: 3px solid transparent; height: 100%; 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; gap: 4px; padding: 0 20px;
        }
        .tab-active { 
            color: var(--royal-blue); border-bottom-color: var(--royal-blue); background: var(--soft-blue); 
        }

        .stat-card { 
            background: white; border: 1px solid var(--border-color); 
            border-radius: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .autocomplete-items { 
            position: absolute; border-radius: 1.5rem; max-height: 400px; 
            overflow-y: auto; z-index: 100; top: 105%; left: 0; right: 0; 
            background: white; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); 
            border: 1px solid var(--border-color); 
        }
        .autocomplete-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        .autocomplete-item:hover { background-color: var(--soft-blue); }

        .satuan-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; }
        .satuan-btn input:checked + .satuan-label { background: var(--royal-blue); color: white; }
        .satuan-label {
            display: block; padding: 12px 4px; text-align: center; background: white;
            border: 2px solid #f1f5f9; border-radius: 16px; font-size: 11px; font-weight: 800;
            cursor: pointer; text-transform: uppercase; color: #64748b;
        }

        @media print { 
            @page { margin: 0; size: 58mm auto; }
            body * { visibility: hidden; }
            #receipt-print, #receipt-print * { visibility: visible; }
            #receipt-print { position: absolute; left: 0; top: 0; width: 48mm; display: block !important; font-family: 'Courier New', monospace; font-size: 9pt; }
        }
        #receipt-print { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        /* Modal Style */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 2.5rem; border-radius: 3rem;
            width: 100%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    </style>
</head>
<body class="pb-10">

    <header class="sticky top-0 z-50 glass">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center h-20">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-xl text-white shadow-lg shadow-blue-200">
                    <i class="fas fa-prescription-bottle-alt text-lg"></i>
                </div>
                <div>
                    <h1 class="text-md font-extrabold uppercase leading-none text-slate-800">Apotek <span class="text-blue-600">Sejahtera</span></h1>
                    <span class="text-[9px] font-bold text-slate-400">DEPAN GOR KARIANGO</span>
                </div>
            </div>
            <nav class="flex h-20 overflow-x-auto">
                <button onclick="showTab('kasir')" id="btn-kasir" class="nav-btn tab-active"><i class="fas fa-cash-register"></i><span class="text-[10px]">KASIR</span></button>
                <button onclick="showTab('history')" id="btn-history" class="nav-btn"><i class="fas fa-file-invoice-dollar"></i><span class="text-[10px]">LAPORAN</span></button>
                <button onclick="showTab('neraca')" id="btn-neraca" class="nav-btn"><i class="fas fa-balance-scale"></i><span class="text-[10px]">NERACA</span></button>
                <button onclick="openAdminGate()" id="btn-admin" class="nav-btn"><i class="fas fa-user-shield"></i><span class="text-[10px]">ADMIN</span></button>
            </nav>
        </div>
    </header>

    <div id="modal-gate" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-xl font-black text-slate-800 mb-6 text-center uppercase tracking-tight">Login Akses</h2>
            <div class="space-y-3">
                <button onclick="showPassInput('super')" class="w-full bg-slate-900 text-white p-5 rounded-2xl font-black flex items-center justify-between hover:bg-slate-800 transition-all group">
                    <div class="flex items-center gap-3"><i class="fas fa-crown text-amber-400"></i> SUPERADMIN</div>
                    <i class="fas fa-chevron-right text-slate-600 group-hover:translate-x-1 transition-transform"></i>
                </button>
                <button onclick="showPassInput('stock')" class="w-full bg-blue-50 text-blue-600 p-5 rounded-2xl font-black flex items-center justify-between hover:bg-blue-100 transition-all group">
                    <div class="flex items-center gap-3"><i class="fas fa-box-open"></i> STOCK LIST</div>
                    <i class="fas fa-chevron-right text-blue-400 group-hover:translate-x-1 transition-transform"></i>
                </button>
                <button onclick="closeAdminGate()" class="w-full text-slate-400 font-bold py-3 text-sm">BATAL</button>
            </div>
        </div>
    </div>

    <div id="modal-pass" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="pass-title" class="text-xl font-black text-slate-800 mb-2 text-center uppercase">Password</h2>
            <p class="text-[10px] text-slate-400 font-bold text-center mb-6 uppercase">Masukkan kode akses untuk masuk</p>
            <input type="password" id="admin-pass-input" onkeypress="if(event.key==='Enter') verifyAccess()" class="w-full p-5 bg-slate-50 border-2 border-slate-50 rounded-2xl mb-4 text-center font-bold text-2xl focus:border-blue-600 outline-none">
            <button onclick="verifyAccess()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black shadow-lg shadow-blue-100 uppercase tracking-widest">MASUK</button>
            <button onclick="backToGate()" class="w-full text-slate-400 font-bold py-3 text-sm mt-2">KEMBALI</button>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4 md:p-8">
        <section id="tab-kasir" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <h2 class="font-black text-xl mb-6 text-slate-800">Cari Obat</h2>
                    <div class="relative mb-6">
                        <i class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-slate-300"></i>
                        <input id="input-search" type="text" placeholder="Ketik nama obat..." autocomplete="off"
                               class="w-full p-5 pl-14 bg-slate-50 border-2 border-slate-50 rounded-3xl outline-none focus:border-blue-600 focus:bg-white text-lg font-bold transition-all">
                        <div id="autocomplete-list" class="autocomplete-items hidden"></div>
                    </div>
                    <div class="satuan-grid mb-6">
                        <label class="satuan-btn"><input type="radio" name="satuan" value="Biji" checked class="hidden"><div class="satuan-label">Biji</div></label>
                        <label class="satuan-btn"><input type="radio" name="satuan" value="Strip" class="hidden"><div class="satuan-label">Strip</div></label>
                        <label class="satuan-btn"><input type="radio" name="satuan" value="Tube" class="hidden"><div class="satuan-label">Tube</div></label>
                        <label class="satuan-btn"><input type="radio" name="satuan" value="Botol" class="hidden"><div class="satuan-label">Botol</div></label>
                    </div>
                    <div class="flex items-center justify-between bg-slate-50 p-4 rounded-3xl border border-slate-100">
                        <span class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-4">Jumlah</span>
                        <div class="flex items-center gap-6 mr-4">
                            <button onclick="adjustQty(-1)" class="w-10 h-10 rounded-full bg-white border shadow-sm font-bold text-xl">-</button>
                            <input type="number" id="input-qty" value="1" min="1" class="w-16 bg-transparent text-2xl font-black outline-none text-center text-blue-600">
                            <button onclick="adjustQty(1)" class="w-10 h-10 rounded-full bg-white border shadow-sm font-bold text-xl">+</button>
                        </div>
                    </div>
                    <button onclick="tambahKeKeranjang()" class="w-full mt-6 bg-blue-600 text-white font-black py-5 rounded-3xl hover:bg-blue-700 shadow-xl shadow-blue-100 uppercase tracking-widest">TAMBAHKAN</button>
                </div>
            </div>
            
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-[2.5rem] shadow-2xl border sticky top-28">
                    <h2 class="font-black text-lg text-slate-800 mb-4">Keranjang Obat</h2>
                    <div id="list-keranjang" class="space-y-3 mb-6 max-h-[35vh] overflow-y-auto pr-2 custom-scroll"></div>
                    <div class="pt-4 border-t space-y-3">
                        <div class="flex justify-between items-end"><span class="text-[10px] font-bold text-slate-400 uppercase">Total</span><span id="total-harga" class="text-2xl font-black text-blue-600">Rp 0</span></div>
                        <input type="number" id="input-tunai" onkeyup="hitungKembalian()" placeholder="Tunai..." class="w-full p-4 bg-slate-50 border-2 rounded-2xl outline-none font-black text-xl text-center focus:border-blue-100 transition-all">
                        <div class="flex justify-between items-center p-4 bg-blue-600 rounded-2xl"><span class="text-[10px] font-bold text-blue-200 uppercase">Kembali</span><span id="text-kembalian" class="text-xl font-black text-white">Rp 0</span></div>
                        <div class="flex gap-2">
                            <button onclick="batalTransaksi()" class="flex-1 bg-red-50 text-red-600 font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest hover:bg-red-100 transition-all">BATAL</button>
                            <button onclick="prosesCheckout()" class="flex-[2] bg-slate-900 text-white font-black py-4 rounded-2xl uppercase tracking-widest hover:bg-slate-800 shadow-lg">CHECKOUT</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-history" class="tab-content hidden space-y-6">
            <h2 class="text-2xl font-black text-slate-800">Laporan Penjualan</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="stat-card p-6 bg-white border-b-4 border-blue-600">
                    <input type="date" id="filter-hari" onchange="updateLaporanHarian()" class="text-[10px] font-bold bg-slate-50 p-1 rounded mb-2">
                    <p class="text-[10px] font-black text-slate-400 uppercase">Harian</p>
                    <h3 id="stat-hari-val" class="text-2xl font-black text-blue-600">Rp 0</h3>
                </div>
                <div class="stat-card p-6 bg-white border-b-4 border-slate-900">
                    <input type="month" id="filter-bulan" onchange="updateLaporanBulanan()" class="text-[10px] font-bold bg-slate-50 p-1 rounded mb-2">
                    <p class="text-[10px] font-black text-slate-400 uppercase">Bulanan</p>
                    <h3 id="stat-bulan-val" class="text-2xl font-black text-slate-900">Rp 0</h3>
                </div>
            </div>
            <div class="bg-white rounded-[2.5rem] border overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase border-b">
                        <tr><th class="p-6">Waktu</th><th class="p-6">Rincian Obat</th><th class="p-6 text-right">Total</th></tr>
                    </thead>
                    <tbody id="tabel-history-raw" class="divide-y text-sm font-semibold"></tbody>
                </table>
            </div>
        </section>

        <section id="tab-neraca" class="tab-content hidden space-y-8">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-black text-slate-800">Neraca Keuangan</h2>
                <input type="month" id="neraca-filter-bulan" onchange="loadNeraca()" class="bg-white border p-3 rounded-2xl font-bold text-sm">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="stat-card p-8 bg-blue-600 text-white">
                    <p class="text-[10px] font-black opacity-70 uppercase tracking-widest">Total Penjualan</p>
                    <h3 id="neraca-total-jual" class="text-3xl font-black">Rp 0</h3>
                </div>
                <div class="stat-card p-8 bg-red-500 text-white">
                    <p class="text-[10px] font-black opacity-70 uppercase tracking-widest">Total Pengeluaran</p>
                    <h3 id="neraca-total-keluar" class="text-3xl font-black">Rp 0</h3>
                </div>
                <div class="stat-card p-8 bg-emerald-500 text-white">
                    <p class="text-[10px] font-black opacity-70 uppercase tracking-widest">Laba Bersih</p>
                    <h3 id="neraca-laba-bersih" class="text-3xl font-black">Rp 0</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm h-fit">
                    <h3 class="font-black text-slate-800 uppercase text-sm mb-6">Input Pengeluaran</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 ml-2 uppercase">Keterangan</label>
                            <input type="text" id="exp-ket" placeholder="Misal: Bayar Listrik" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 ml-2 uppercase">Jumlah (Rp)</label>
                            <input type="number" id="exp-nom" placeholder="0" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 ml-2 uppercase">Tanggal</label>
                            <input type="date" id="exp-tgl" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold">
                        </div>
                        <button onclick="simpanPengeluaran()" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl uppercase tracking-widest hover:shadow-lg transition-all">SIMPAN</button>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white rounded-[2.5rem] border border-slate-100 overflow-hidden shadow-sm">
                    <div class="p-6 border-b bg-slate-50/50">
                        <h3 class="font-black text-slate-700 uppercase text-xs">Daftar Pengeluaran Bulanan</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="text-[10px] font-black text-slate-300 uppercase border-b bg-white">
                                <tr><th class="p-6">Tanggal</th><th class="p-6">Keterangan</th><th class="p-6 text-right">Nominal</th><th class="p-6 text-center">Aksi</th></tr>
                            </thead>
                            <tbody id="tabel-pengeluaran" class="divide-y text-sm font-semibold"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-admin" class="tab-content hidden space-y-6">
            <div id="admin-content" class="space-y-6">
                <div class="bg-white p-8 rounded-[2.5rem] border">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-black" id="admin-title">Tambah Obat Baru</h2>
                        <button onclick="logoutAdmin()" class="text-red-500 font-bold bg-red-50 px-4 py-2 rounded-xl text-[10px]">LOGOUT</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        <input type="hidden" id="admin-edit-id">
                        <input type="text" id="admin-nama" placeholder="Nama Obat" class="p-4 bg-slate-50 rounded-2xl font-bold">
                        <input type="number" id="admin-harga-biji" placeholder="Harga Biji" class="p-4 bg-slate-50 rounded-2xl font-bold">
                        <input type="number" id="admin-harga-box" placeholder="Harga Strip/Tube/Botol" class="p-4 bg-slate-50 rounded-2xl font-bold">
                        <input type="number" id="admin-stok" placeholder="Stok" class="p-4 bg-slate-50 rounded-2xl font-bold">
                        <input type="date" id="admin-expired" class="p-4 bg-slate-50 rounded-2xl font-bold">
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="updateDataObat()" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black uppercase shadow-lg shadow-blue-100" id="btn-save-admin">Simpan Data</button>
                        <button onclick="resetAdminForm()" id="btn-cancel-admin" class="hidden bg-slate-200 text-slate-600 px-8 rounded-2xl font-black">BATAL</button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-[2.5rem] border">
                    <div class="relative">
                        <i class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-slate-300"></i>
                        <input id="admin-search-table" type="text" onkeyup="filterTabelAdmin()" placeholder="Cari obat di tabel stok..." 
                               class="w-full p-4 pl-14 bg-slate-50 border-2 border-slate-50 rounded-2xl outline-none focus:border-blue-600 focus:bg-white font-bold transition-all">
                    </div>
                </div>

                <div class="bg-white rounded-[2.5rem] border overflow-hidden">
                    <table class="w-full text-left" id="table-stok-obat">
                        <thead class="bg-slate-50 text-[10px] font-black text-slate-300 uppercase">
                            <tr>
                                <th class="p-6">Produk</th>
                                <th class="p-6">Harga (Biji/Strip)</th>
                                <th class="p-6">Stok</th>
                                <th id="th-aksi" class="p-6 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-stok" class="divide-y font-semibold text-sm"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="receipt-print"></div>
    <div id="toast-container" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[9999] space-y-2 text-center w-full max-w-xs px-4"></div>

    <script>
        // CONFIGURASI AKSES
        const ACCESS = {
            super: "12345",
            stock: "100"
        };
        let currentRole = ""; // 'super' atau 'stock'
        let pendingRole = "";

        const firebaseConfig = {
            apiKey: "AIzaSyCfi8bqVns9WvdrbTMVcJkYcKn-w1lX-Go",
            authDomain: "ap0tik-reny.firebaseapp.com",
            projectId: "ap0tik-reny",
            databaseURL: "https://ap0tik-reny-default-rtdb.asia-southeast1.firebasedatabase.app/", 
            storageBucket: "ap0tik-reny.firebasestorage.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let dataObatGlobal = {}, dataHistoryGlobal = {}, dataPengeluaranGlobal = {}, keranjang = [];

        function getWITA() { const d = new Date(); return new Date(d.getTime() + (d.getTimezoneOffset() * 60000) + (3600000 * 8)); }
        function getISO(d) { return (d || getWITA()).toISOString().split('T')[0]; }
        function adjustQty(v) { let el = document.getElementById('input-qty'); el.value = Math.max(1, parseInt(el.value) + v); }

        db.ref('obat').on('value', s => { dataObatGlobal = s.val() || {}; renderAdminTable(); });
        db.ref('history').on('value', s => { dataHistoryGlobal = s.val() || {}; initLaporanDefault(); loadNeraca(); });
        db.ref('pengeluaran').on('value', s => { dataPengeluaranGlobal = s.val() || {}; loadNeraca(); });

        // --- GATE & AUTH LOGIC ---
        function openAdminGate() {
            if(currentRole) { showTab('admin'); return; }
            document.getElementById('modal-gate').classList.remove('hidden');
        }
        function closeAdminGate() { document.getElementById('modal-gate').classList.add('hidden'); }
        
        function showPassInput(role) {
            pendingRole = role;
            document.getElementById('modal-gate').classList.add('hidden');
            document.getElementById('modal-pass').classList.remove('hidden');
            document.getElementById('pass-title').innerText = "Login " + role.toUpperCase();
            document.getElementById('admin-pass-input').value = "";
            document.getElementById('admin-pass-input').focus();
        }

        function backToGate() {
            document.getElementById('modal-pass').classList.add('hidden');
            document.getElementById('modal-gate').classList.remove('hidden');
        }

        function verifyAccess() {
            const val = document.getElementById('admin-pass-input').value;
            if(val === ACCESS[pendingRole]) {
                currentRole = pendingRole;
                document.getElementById('modal-pass').classList.add('hidden');
                initAdminView();
            } else {
                showToast("Password Salah!", "error");
            }
        }

        function initAdminView() {
            showTab('admin');
            const thAksi = document.getElementById('th-aksi');
            
            // Atur tampilan header aksi berdasarkan role
            if(currentRole === 'super') {
                thAksi.classList.remove('hidden');
            } else {
                thAksi.classList.add('hidden');
            }
            renderAdminTable();
        }

        function logoutAdmin() {
            currentRole = "";
            showTab('kasir');
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('tab-active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('btn-' + id).classList.add('tab-active');
            if(id === 'neraca') loadNeraca();
        }

        // --- KASIR ---
        const inpS = document.getElementById('input-search');
        const listS = document.getElementById('autocomplete-list');
        inpS.addEventListener('input', function() {
            const val = this.value.toLowerCase(); listS.innerHTML = '';
            if(!val) { listS.classList.add('hidden'); return; }
            Object.keys(dataObatGlobal).forEach(k => {
                const it = dataObatGlobal[k];
                if(it.nama.toLowerCase().includes(val)) {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item font-bold text-slate-700';
                    const expStr = it.expired ? it.expired : '-';
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span>${it.nama}</span>
                            <span class="text-[9px] bg-slate-100 px-2 py-1 rounded text-slate-500 uppercase">EXP: ${expStr}</span>
                        </div>
                        <div class="text-[10px] text-blue-600 mt-1">Rp${it.harga_biji.toLocaleString()} | Stok: ${it.stok}</div>
                    `;
                    div.onclick = () => { inpS.value = it.nama; inpS.dataset.id = k; listS.classList.add('hidden'); };
                    listS.appendChild(div);
                }
            });
            listS.classList.remove('hidden');
        });

        function tambahKeKeranjang() {
            const id = inpS.dataset.id; const qty = parseInt(document.getElementById('input-qty').value);
            const sat = document.querySelector('input[name="satuan"]:checked').value;
            if(!id) return;
            const it = dataObatGlobal[id]; 
            let h = (sat === 'Strip' || sat === 'Tube') ? it.harga_box : it.harga_biji;
            keranjang.push({ id, nama: it.nama, qty, satuan: sat, harga: h, subtotal: h*qty });
            renderKeranjang(); inpS.value = ''; delete inpS.dataset.id;
        }

        function hapusItemKeranjang(index) {
            keranjang.splice(index, 1);
            renderKeranjang();
        }

        function batalTransaksi() {
            if(keranjang.length === 0) return;
            if(confirm("Batalkan seluruh transaksi ini?")) {
                keranjang = [];
                document.getElementById('input-tunai').value = '';
                renderKeranjang();
                showToast("Transaksi Dibatalkan", "error");
            }
        }

        function renderKeranjang() {
            const c = document.getElementById('list-keranjang'); c.innerHTML = ''; let t = 0;
            keranjang.forEach((it, i) => {
                t += it.subtotal;
                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-2xl flex justify-between items-center border shadow-sm";
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="text-[10px] font-black uppercase text-slate-800">${it.nama}</div>
                        <div class="text-[9px] text-slate-400 font-bold">${it.qty} ${it.satuan} x Rp${it.harga.toLocaleString()}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="font-black text-blue-600 text-xs">Rp${it.subtotal.toLocaleString()}</div>
                        <button onclick="hapusItemKeranjang(${i})" class="w-7 h-7 flex items-center justify-center bg-red-50 text-red-500 rounded-full hover:bg-red-500 hover:text-white transition-all">
                            <i class="fas fa-times text-[10px]"></i>
                        </button>
                    </div>
                `;
                c.appendChild(div);
            });
            document.getElementById('total-harga').innerText = "Rp " + t.toLocaleString();
            window.totalT = t; hitungKembalian();
        }

        function hitungKembalian() {
            const t = parseInt(document.getElementById('input-tunai').value) || 0;
            const k = t - (window.totalT || 0);
            document.getElementById('text-kembalian').innerText = "Rp " + (k < 0 ? 0 : k).toLocaleString();
        }

        async function prosesCheckout() {
            if(!keranjang.length) { showToast("Keranjang kosong!", "error"); return; }
            if((parseInt(document.getElementById('input-tunai').value) || 0) < window.totalT) { showToast("Tunai tidak cukup!", "error"); return; }
            const now = getWITA(); const up = {};
            keranjang.forEach(it => { up[`/obat/${it.id}/stok`] = (dataObatGlobal[it.id].stok || 0) - it.qty; });
            await db.ref().update(up);
            const d = { tanggal: getISO(now), isoDate: getISO(now), bulan: getISO(now).substring(0,7), tahun: now.getFullYear().toString(), total: window.totalT, items: keranjang, timestamp: now.getTime(), tunai: parseInt(document.getElementById('input-tunai').value) };
            await db.ref('history').push(d);
            keranjang = []; renderKeranjang(); document.getElementById('input-tunai').value = ''; showToast("Berhasil", "success");
        }

        // --- NERACA ---
        function loadNeraca() {
            const filter = document.getElementById('neraca-filter-bulan').value || getISO().substring(0,7);
            document.getElementById('neraca-filter-bulan').value = filter;
            let tj = 0; let tk = 0;
            Object.values(dataHistoryGlobal).forEach(d => { if(d.bulan === filter) tj += d.total; });
            const tb = document.getElementById('tabel-pengeluaran'); tb.innerHTML = '';
            Object.keys(dataPengeluaranGlobal).forEach(k => {
                const p = dataPengeluaranGlobal[k];
                if(p.bulan === filter) {
                    tk += p.nominal;
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="p-6 text-[11px]">${p.tanggal}</td><td class="p-6 uppercase font-bold text-slate-700">${p.keterangan}</td><td class="p-6 text-right font-black">Rp ${p.nominal.toLocaleString()}</td><td class="p-6 text-center"><button onclick="hapusPengeluaran('${k}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td>`;
                    tb.appendChild(row);
                }
            });
            document.getElementById('neraca-total-jual').innerText = "Rp " + tj.toLocaleString();
            document.getElementById('neraca-total-keluar').innerText = "Rp " + tk.toLocaleString();
            document.getElementById('neraca-laba-bersih').innerText = "Rp " + (tj - tk).toLocaleString();
        }

        async function simpanPengeluaran() {
            const ket = document.getElementById('exp-ket').value;
            const nom = parseInt(document.getElementById('exp-nom').value);
            const tgl = document.getElementById('exp-tgl').value;
            if(!ket || !nom || !tgl) { showToast("Lengkapi Data", "error"); return; }
            const data = { keterangan: ket, nominal: nom, tanggal: tgl, bulan: tgl.substring(0,7), timestamp: new Date(tgl).getTime() };
            await db.ref('pengeluaran').push(data);
            document.getElementById('exp-ket').value = ''; document.getElementById('exp-nom').value = '';
            showToast("Pengeluaran Dicatat", "success");
        }

        async function hapusPengeluaran(k) { if(confirm("Hapus catatan?")) await db.ref('pengeluaran/'+k).remove(); }

        // --- LAPORAN ---
        function initLaporanDefault() {
            const v = getISO();
            if(!document.getElementById('filter-hari').value) {
                document.getElementById('filter-hari').value = v;
                document.getElementById('filter-bulan').value = v.substring(0,7);
                document.getElementById('exp-tgl').value = v;
            }
            updateLaporanHarian(); updateLaporanBulanan(); renderTabelHistory();
        }
        function updateLaporanHarian() { let t=0; const v=document.getElementById('filter-hari').value; Object.values(dataHistoryGlobal).forEach(d=>{if(d.isoDate===v) t+=d.total;}); document.getElementById('stat-hari-val').innerText="Rp "+t.toLocaleString(); }
        function updateLaporanBulanan() { let t=0; const v=document.getElementById('filter-bulan').value; Object.values(dataHistoryGlobal).forEach(d=>{if(d.bulan===v) t+=d.total;}); document.getElementById('stat-bulan-val').innerText="Rp "+t.toLocaleString(); }
        function renderTabelHistory() {
            const tr = document.getElementById('tabel-history-raw'); tr.innerHTML = '';
            Object.values(dataHistoryGlobal).sort((a,b)=>b.timestamp-a.timestamp).slice(0,20).forEach(d => {
                const items = d.items.map(i => `<div class="text-[9px]">â€¢ ${i.nama} (${i.qty})</div>`).join('');
                const row = document.createElement('tr');
                row.innerHTML = `<td class="p-6 text-[10px]">${d.tanggal}</td><td class="p-6">${items}</td><td class="p-6 text-right font-black">Rp ${d.total.toLocaleString()}</td>`;
                tr.appendChild(row);
            });
        }

        // --- ADMIN ---
        function filterTabelAdmin() {
            const val = document.getElementById('admin-search-table').value.toLowerCase();
            const rows = document.getElementById('tabel-stok').getElementsByTagName('tr');
            for (let row of rows) {
                const text = row.cells[0].textContent.toLowerCase();
                row.style.display = text.includes(val) ? "" : "none";
            }
        }

        function renderAdminTable() {
            const tb = document.getElementById('tabel-stok'); tb.innerHTML = '';
            Object.keys(dataObatGlobal).forEach(k => {
                const it = dataObatGlobal[k];
                const row = document.createElement('tr');
                
                let aksiHTML = "";
                // HANYA RENDER AKSI JIKA ROLE ADALAH SUPER
                if(currentRole === 'super') {
                    aksiHTML = `<td class="p-6 text-right">
                        <button onclick="editObat('${k}')" class="text-blue-500 bg-blue-50 w-10 h-10 rounded-xl"><i class="fas fa-pen"></i></button>
                        <button onclick="hapusObat('${k}')" class="text-red-500 bg-red-50 w-10 h-10 rounded-xl ml-2"><i class="fas fa-trash"></i></button>
                    </td>`;
                }

                row.innerHTML = `<td class="p-6 font-bold uppercase text-xs">${it.nama}</td><td class="p-6 text-[10px]">Biji: Rp${it.harga_biji.toLocaleString()}<br>Strip: Rp${(it.harga_box||0).toLocaleString()}</td><td class="p-6 text-center font-black">${it.stok}</td>${aksiHTML}`;
                tb.appendChild(row);
            });
            filterTabelAdmin();
        }

        function editObat(id) {
            if(currentRole !== 'super') return;
            const it = dataObatGlobal[id];
            document.getElementById('admin-edit-id').value = id;
            document.getElementById('admin-nama').value = it.nama;
            document.getElementById('admin-harga-biji').value = it.harga_biji;
            document.getElementById('admin-harga-box').value = it.harga_box;
            document.getElementById('admin-stok').value = it.stok;
            document.getElementById('admin-expired').value = it.expired || '';
            document.getElementById('admin-title').innerText = "Edit: " + it.nama;
            document.getElementById('btn-save-admin').innerText = "UPDATE DATA OBAT";
            document.getElementById('btn-cancel-admin').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function updateDataObat() {
            const n = document.getElementById('admin-nama').value;
            const hb = parseInt(document.getElementById('admin-harga-biji').value);
            const idEdit = document.getElementById('admin-edit-id').value;
            if(!n || isNaN(hb)) { showToast("Nama & Harga wajib isi", "error"); return; }
            const id = idEdit || n.toLowerCase().replace(/\s+/g,'-');
            const payload = { nama: n, harga_biji: hb, harga_box: parseInt(document.getElementById('admin-harga-box').value)||0, stok: parseInt(document.getElementById('admin-stok').value)||0, expired: document.getElementById('admin-expired').value };
            await db.ref('obat/'+id).update(payload);
            showToast("Berhasil", "success"); resetAdminForm();
        }

        function resetAdminForm() {
            ['admin-nama','admin-harga-biji','admin-harga-box','admin-stok','admin-expired','admin-edit-id'].forEach(i=>document.getElementById(i).value='');
            document.getElementById('admin-title').innerText = "Tambah Obat Baru";
            document.getElementById('btn-save-admin').innerText = "Simpan Data";
            document.getElementById('btn-cancel-admin').classList.add('hidden');
        }

        async function hapusObat(id) { 
            if(currentRole !== 'super') return;
            if(confirm("Hapus permanen obat ini?")) await db.ref('obat/'+id).remove(); 
        }

        function showToast(m, t) {
            const c = document.getElementById('toast-container'); const d = document.createElement('div');
            d.className = `${t==='success'?'bg-blue-600':'bg-red-600'} text-white px-6 py-3 rounded-2xl shadow-xl font-black text-[10px] uppercase animate-bounce`;
            d.innerText = m; c.appendChild(d); setTimeout(()=>d.remove(), 2000);
        }
    </script>
</body>
</html>


