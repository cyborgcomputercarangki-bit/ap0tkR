<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apotek Reny - Multi Price System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .tab-active { color: #2563eb; border-bottom: 3px solid #2563eb; background: rgba(37, 99, 235, 0.05); }
        .hidden { display: none; }
        .autocomplete-items {
            position: absolute; border-radius: 1.25rem; max-height: 400px; overflow-y: auto;
            z-index: 100; top: 100%; left: 0; right: 0; background: white;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); border: 1px solid #e2e8f0; margin-top: 8px;
        }
        .autocomplete-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #f1f5f9; transition: 0.2s; }
        .autocomplete-item:hover { background: #eff6ff; padding-left: 28px; }
        .autocomplete-items::-webkit-scrollbar { width: 6px; }
        .autocomplete-items::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-800">

    <header class="sticky top-0 z-50 glass border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-xl text-white shadow-lg">
                    <i class="fas fa-pills text-lg"></i>
                </div>
                <h1 class="text-lg font-bold">Apotek Reny</h1>
            </div>
            <nav class="flex h-16">
                <button onclick="showTab('kasir')" id="btn-kasir" class="px-4 md:px-6 font-bold text-slate-500 tab-active flex items-center gap-2">
                    <i class="fas fa-cash-register text-sm"></i> <span>Kasir</span>
                </button>
                <button onclick="showTab('history')" id="btn-history" class="px-4 md:px-6 font-bold text-slate-500 flex items-center gap-2">
                    <i class="fas fa-file-invoice-dollar text-sm"></i> <span>Laporan</span>
                </button>
                <button onclick="showTab('admin')" id="btn-admin" class="px-4 md:px-6 font-bold text-slate-500 flex items-center gap-2 border-l border-slate-100 ml-2">
                    <i class="fas fa-user-shield text-sm text-red-500"></i> <span>Admin</span>
                </button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8">
        
        <section id="tab-kasir" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-slate-200">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-slate-700">
                        <i class="fas fa-search text-blue-500"></i> Cari Obat
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                        <div class="md:col-span-6 relative">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Nama Obat</label>
                            <input id="input-search" type="text" autocomplete="off" placeholder="Klik untuk melihat list..." 
                                class="w-full mt-1 p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-medium transition">
                            <div id="autocomplete-list" class="autocomplete-items hidden"></div>
                            <input type="hidden" id="selected-id">
                        </div>
                        <div class="md:col-span-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Qty</label>
                            <input type="number" id="input-qty" value="1" min="1" class="w-full mt-1 p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-bold text-center">
                        </div>
                        <div class="md:col-span-4">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Pilih Satuan</label>
                            <select id="input-satuan" class="w-full mt-1 p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none appearance-none font-medium text-blue-600 font-bold">
                                <option value="biji">Biji (Eceran)</option>
                                <option value="box">Pack / Box (Grosir)</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="tambahKeKeranjang()" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl transition shadow-lg flex justify-center items-center gap-2">
                        <i class="fas fa-cart-plus"></i> Tambahkan Ke List
                    </button>
                    
                    <div class="mt-8 pt-6 border-t border-dashed">
                        <button onclick="initMultiPriceDatabase()" class="text-[11px] bg-slate-100 hover:bg-emerald-600 hover:text-white text-slate-600 px-4 py-2 rounded-xl transition font-black uppercase tracking-wider">
                            <i class="fas fa-sync-alt mr-2"></i> Update Database Pro (Multi-Price)
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-blue-100 sticky top-24">
                    <h2 class="text-xl font-bold mb-4 text-slate-700">Rincian Harga</h2>
                    <div id="list-keranjang" class="space-y-3 mb-6 pr-1 max-h-80 overflow-y-auto">
                        <p class="text-center text-slate-300 italic py-4">Belum ada pilihan</p>
                    </div>
                    <div class="space-y-4 pt-4 border-t border-slate-100">
                        <div class="flex justify-between text-lg font-black text-slate-900">
                            <span>TOTAL</span>
                            <span id="total-harga" class="text-blue-600">Rp 0</span>
                        </div>
                        <input type="number" id="input-tunai" onkeyup="hitungKembalian()" placeholder="Uang Tunai..." class="w-full p-4 bg-blue-50 border border-blue-100 rounded-2xl outline-none font-black text-xl text-blue-700">
                        <div class="flex justify-between items-center p-4 bg-slate-900 rounded-2xl text-white">
                            <span class="text-xs font-bold text-slate-400 uppercase">Kembali</span>
                            <span id="text-kembalian" class="text-2xl font-black text-emerald-400">Rp 0</span>
                        </div>
                        <button onclick="prosesCheckout()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-black py-4 rounded-2xl shadow-lg transition uppercase tracking-widest text-sm">
                            Simpan Transaksi
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-history" class="hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Hari Ini</p>
                    <h3 id="stat-hari" class="text-2xl font-black text-blue-600 mt-1">Rp 0</h3>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Bulan Ini</p>
                    <h3 id="stat-bulan" class="text-2xl font-black text-emerald-600 mt-1">Rp 0</h3>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Tahun Ini</p>
                    <h3 id="stat-tahun" class="text-2xl font-black text-orange-600 mt-1">Rp 0</h3>
                </div>
            </div>
            <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase">
                        <tr><th class="p-5">Waktu</th><th class="p-5">Item terjual</th><th class="p-5 text-right">Total</th></tr>
                    </thead>
                    <tbody id="tabel-history" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </section>

        <section id="tab-admin" class="hidden space-y-6">
            <div id="admin-auth" class="max-w-md mx-auto bg-white p-8 rounded-3xl shadow-2xl text-center py-12 border">
                <i class="fas fa-lock text-red-500 text-3xl mb-4"></i>
                <h2 class="text-xl font-black mb-6 text-slate-700">Login Admin</h2>
                <input type="password" id="admin-pass" placeholder="Password" class="w-full p-4 bg-slate-50 border rounded-2xl mb-4 text-center outline-none">
                <button onclick="loginAdmin()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">Buka Kunci</button>
            </div>
            <div id="admin-content" class="hidden space-y-6">
                <div class="bg-slate-900 p-8 rounded-3xl text-white shadow-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold">Database & Stok</h2>
                        <button onclick="logoutAdmin()" class="text-xs text-red-400 font-bold uppercase">Logout</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <input type="text" id="admin-nama" placeholder="Nama Obat" class="p-4 bg-slate-800 rounded-2xl outline-none">
                        <input type="number" id="admin-harga-biji" placeholder="Harga BIJI" class="p-4 bg-slate-800 rounded-2xl outline-none border border-blue-500/30">
                        <input type="number" id="admin-harga-box" placeholder="Harga BOX" class="p-4 bg-slate-800 rounded-2xl outline-none border border-emerald-500/30">
                        <input type="number" id="admin-stok" placeholder="Stok (Biji)" class="p-4 bg-slate-800 rounded-2xl outline-none">
                    </div>
                    <button onclick="updateDataObat()" class="w-full mt-6 bg-blue-600 py-4 rounded-2xl font-bold">Simpan Obat</button>
                </div>
                <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase border-b">
                            <tr><th class="p-5">Obat</th><th class="p-5">Harga Biji</th><th class="p-5">Harga Box</th><th class="p-5 text-center">Stok</th><th class="p-5 text-right">Aksi</th></tr>
                        </thead>
                        <tbody id="tabel-stok" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script>
        const MASTER_PASS = "reny123";
        const firebaseConfig = {
            apiKey: "AIzaSyCfi8bqVns9WvdrbTMVcJkYcKn-w1lX-Go",
            authDomain: "ap0tik-reny.firebaseapp.com",
            projectId: "ap0tik-reny",
            databaseURL: "https://ap0tik-reny-default-rtdb.asia-southeast1.firebasedatabase.app/", 
            storageBucket: "ap0tik-reny.firebasestorage.app",
            messagingSenderId: "463406659344",
            appId: "1:463406659344:web:27bd0a3b1bb884432b5795"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let dataObatGlobal = {};
        let keranjang = [];
        let totalTagihan = 0;

        // FUNGSI UPDATE DATABASE MASIF (MULTI PRICE)
        function initMultiPriceDatabase() {
            const data = {
                // FLU & DEMAM
                "panadol-biru": { nama: "Panadol Biru", harga_biji: 1500, harga_box: 13500, stok: 100 },
                "panadol-merah": { nama: "Panadol Merah (Extra)", harga_biji: 2000, harga_box: 15500, stok: 100 },
                "bodrex-original": { nama: "Bodrex Original", harga_biji: 1000, harga_box: 8500, stok: 200 },
                "stopcold": { nama: "Stopcold", harga_biji: 1500, harga_box: 5500, stok: 100 },
                "mixagrip-flu": { nama: "Mixagrip Flu", harga_biji: 1000, harga_box: 8000, stok: 150 },
                "ultraflu": { nama: "Ultraflu", harga_biji: 1000, harga_box: 8500, stok: 150 },
                "paracetamol-500": { nama: "Paracetamol 500mg", harga_biji: 500, harga_box: 5000, stok: 500 },
                "sanmol-tablet": { nama: "Sanmol Tablet", harga_biji: 1000, harga_box: 10000, stok: 100 },
                "biogesic": { nama: "Biogesic", harga_biji: 1000, harga_box: 9000, stok: 200 },
                "neozep-forte": { nama: "Neozep Forte", harga_biji: 1000, harga_box: 9500, stok: 100 },
                
                // MAAG & PENCERNAAN
                "promag-tablet": { nama: "Promag Tablet", harga_biji: 1000, harga_box: 9000, stok: 150 },
                "mylanta-tablet": { nama: "Mylanta Tablet", harga_biji: 1500, harga_box: 12000, stok: 100 },
                "entrostop": { nama: "Entrostop", harga_biji: 1000, harga_box: 8000, stok: 200 },
                "diapet": { nama: "Diapet Kapsul", harga_biji: 1000, harga_box: 7500, stok: 200 },
                "new-diatabs": { nama: "New Diatabs", harga_biji: 1000, harga_box: 9000, stok: 150 },
                "dulcolax-5mg": { nama: "Dulcolax 5mg", harga_biji: 2000, harga_box: 18000, stok: 100 },

                // ANTIBIOTIK & LAINNYA
                "amoxilin-500": { nama: "Amoxilin 500mg", harga_biji: 1500, harga_box: 12000, stok: 100 },
                "neuralgin": { nama: "Neuralgin Rhema", harga_biji: 1500, harga_box: 13000, stok: 100 },
                "super-tetra": { nama: "Super Tetra", harga_biji: 2500, harga_box: 22000, stok: 50 },
                "fg-troches": { nama: "FG Troches", harga_biji: 2000, harga_box: 18000, stok: 100 },
                "ctm": { nama: "CTM (Alergi)", harga_biji: 200, harga_box: 5000, stok: 1000 },
                "dexa-05": { nama: "Dexamethasone 0.5", harga_biji: 500, harga_box: 4500, stok: 500 },

                // SIRUP / BOTOL (Harga Biji = Harga Box karena tidak bisa diecer)
                "obh-combi-60ml": { nama: "OBH Combi Dewasa 60ml", harga_biji: 22000, harga_box: 22000, stok: 30 },
                "komix-sachet": { nama: "Komix Herbal Sachet", harga_biji: 2500, harga_box: 30000, stok: 200 },
                "tolak-angin": { nama: "Tolak Angin Cair", harga_biji: 4000, harga_box: 45000, stok: 300 },
                "minyak-kayu-putih-60": { nama: "Minyak Kayu Putih 60ml", harga_biji: 28000, harga_box: 28000, stok: 40 },
                "betadine-15ml": { nama: "Betadine 15ml", harga_biji: 18000, harga_box: 18000, stok: 40 },
                "hansaplast": { nama: "Hansaplast Kain", harga_biji: 1000, harga_box: 45000, stok: 500 }
            };
            if(confirm("Update 100+ data dengan harga Biji vs Box?")) {
                db.ref('obat').set(data);
                alert("Berhasil!");
            }
        }

        db.ref('obat').on('value', (s) => { if(s.exists()) dataObatGlobal = s.val(); renderAdminTable(); });
        db.ref('history').on('value', (s) => { renderHistory(s.val()); calculateStats(s.val()); });

        // HYBRID SEARCH
        const inpSearch = document.getElementById('input-search');
        const listSearch = document.getElementById('autocomplete-list');

        function renderSearch() {
            const v = inpSearch.value.toLowerCase();
            listSearch.innerHTML = '';
            const keys = Object.keys(dataObatGlobal).sort((a,b) => dataObatGlobal[a].nama.localeCompare(dataObatGlobal[b].nama));
            keys.forEach(k => {
                const it = dataObatGlobal[k];
                if(it.nama.toLowerCase().includes(v)) {
                    const d = document.createElement('div');
                    d.className = 'autocomplete-item';
                    d.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div><div class="font-bold">${it.nama}</div><div class="text-[10px] text-blue-500 uppercase">Stok: ${it.stok}</div></div>
                            <div class="text-right"><div class="text-[10px] font-bold text-slate-400">Biji: Rp ${it.harga_biji.toLocaleString()}</div><div class="text-[10px] font-bold text-emerald-500">Box: Rp ${it.harga_box.toLocaleString()}</div></div>
                        </div>`;
                    d.onclick = () => {
                        inpSearch.value = it.nama;
                        document.getElementById('selected-id').value = k;
                        listSearch.classList.add('hidden');
                    };
                    listSearch.appendChild(d);
                }
            });
            listSearch.classList.remove('hidden');
        }

        inpSearch.addEventListener('focus', renderSearch);
        inpSearch.addEventListener('input', renderSearch);
        document.addEventListener('click', (e) => { if(e.target !== inpSearch) setTimeout(()=>listSearch.classList.add('hidden'), 200); });

        // TRANSAKSI
        function tambahKeKeranjang() {
            const id = document.getElementById('selected-id').value;
            const qty = parseInt(document.getElementById('input-qty').value);
            const satuan = document.getElementById('input-satuan').value;
            if(!id || qty < 1) return alert("Pilih obat!");

            const it = dataObatGlobal[id];
            const harga = (satuan === 'biji') ? it.harga_biji : it.harga_box;
            const sub = harga * qty;

            keranjang.push({ id, nama: it.nama, qty, satuan, harga, subtotal: sub });
            renderKeranjang();
            inpSearch.value = ''; document.getElementById('selected-id').value = '';
        }

        function renderKeranjang() {
            const b = document.getElementById('list-keranjang');
            b.innerHTML = ''; totalTagihan = 0;
            if(keranjang.length === 0) b.innerHTML = '<p class="text-center text-slate-300 italic py-4">Kosong</p>';
            keranjang.forEach((it, i) => {
                totalTagihan += it.subtotal;
                b.innerHTML += `
                    <div class="bg-slate-50 p-3 rounded-2xl flex justify-between items-center text-xs border border-slate-100">
                        <div><b>${it.nama}</b><br><span class="text-blue-500 uppercase font-bold text-[9px]">${it.qty} ${it.satuan} @ Rp ${it.harga.toLocaleString()}</span></div>
                        <div class="flex items-center gap-3"><b>Rp ${it.subtotal.toLocaleString()}</b><button onclick="hapusItem(${i})" class="text-red-300"><i class="fas fa-times-circle"></i></button></div>
                    </div>`;
            });
            document.getElementById('total-harga').innerText = "Rp " + totalTagihan.toLocaleString();
            hitungKembalian();
        }

        function hitungKembalian() {
            const t = parseInt(document.getElementById('input-tunai').value) || 0;
            const k = t - totalTagihan;
            document.getElementById('text-kembalian').innerText = "Rp " + (k < 0 ? 0 : k).toLocaleString();
        }

        async function prosesCheckout() {
            if(keranjang.length === 0) return;
            const t = parseInt(document.getElementById('input-tunai').value) || 0;
            if(t < totalTagihan) return alert("Uang kurang!");
            const n = new Date();
            const up = {};
            const h = { timestamp: n.getTime(), tanggal: n.toISOString().split('T')[0], bulan: n.toISOString().substring(0,7), tahun: n.toISOString().substring(0,4), items: keranjang, total: totalTagihan };
            
            keranjang.forEach(it => {
                // Di sini stok selalu dikurangi dalam satuan "Biji"
                // Anda bisa menyesuaikan logika jika 1 box = 10 biji dsb
                up[`/obat/${it.id}/stok`] = dataObatGlobal[it.id].stok - it.qty;
            });

            try {
                await db.ref().update(up);
                await db.ref('history').push(h);
                alert("Tersimpan!");
                keranjang = []; document.getElementById('input-tunai').value = ''; renderKeranjang();
            } catch(e) { alert("Error DB"); }
        }

        // STATS & ADMIN
        function calculateStats(h) {
            if(!h) return;
            const n = new Date().toISOString();
            const hI = n.split('T')[0], bI = hI.substring(0,7), tI = hI.substring(0,4);
            let th=0, tb=0, tt=0;
            Object.values(h).forEach(d => {
                if(d.tanggal === hI) th += d.total;
                if(d.bulan === bI) tb += d.total;
                if(d.tahun === tI) tt += d.total;
            });
            document.getElementById('stat-hari').innerText = "Rp " + th.toLocaleString();
            document.getElementById('stat-bulan').innerText = "Rp " + tb.toLocaleString();
            document.getElementById('stat-tahun').innerText = "Rp " + tt.toLocaleString();
        }

        function renderHistory(h) {
            const tb = document.getElementById('tabel-history');
            tb.innerHTML = ''; if(!h) return;
            Object.keys(h).reverse().forEach(k => {
                const d = h[k];
                const jam = new Date(d.timestamp).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                const r = d.items.map(i => `${i.nama} (${i.qty} ${i.satuan})`).join(', ');
                tb.innerHTML += `<tr><td class="p-5 text-slate-400"><b>${d.tanggal}</b><br>${jam}</td><td class="p-5">${r}</td><td class="p-5 text-right font-black text-blue-600">Rp ${d.total.toLocaleString()}</td></tr>`;
            });
        }

        function renderAdminTable() {
            const tb = document.getElementById('tabel-stok');
            tb.innerHTML = '';
            for(let id in dataObatGlobal) {
                const it = dataObatGlobal[id];
                tb.innerHTML += `<tr><td class="p-5 font-bold">${it.nama}</td><td class="p-5 text-blue-600 font-bold">Rp ${it.harga_biji.toLocaleString()}</td><td class="p-5 text-emerald-600 font-bold">Rp ${it.harga_box.toLocaleString()}</td><td class="p-5 text-center font-black">${it.stok}</td><td class="p-5 text-right"><button onclick="hapusObat('${id}')" class="text-red-300"><i class="fas fa-trash"></i></button></td></tr>`;
            }
        }

        function updateDataObat() {
            const n = document.getElementById('admin-nama').value;
            const hb = parseInt(document.getElementById('admin-harga-biji').value);
            const hx = parseInt(document.getElementById('admin-harga-box').value);
            const s = parseInt(document.getElementById('admin-stok').value);
            if(!n || isNaN(hb)) return alert("Isi data!");
            const id = n.toLowerCase().replace(/[^a-z0-9]/g, '-');
            db.ref('obat/'+id).set({ nama:n, harga_biji:hb, harga_box:hx, stok:s });
            alert("Berhasil!");
        }

        function hapusObat(id) { if(confirm('Hapus?')) db.ref('obat/'+id).remove(); }
        function loginAdmin() { if(document.getElementById('admin-pass').value === MASTER_PASS) { document.getElementById('admin-auth').classList.add('hidden'); document.getElementById('admin-content').classList.remove('hidden'); } }
        function logoutAdmin() { document.getElementById('admin-auth').classList.remove('hidden'); document.getElementById('admin-content').classList.add('hidden'); }
        function showTab(t) {
            ['kasir', 'history', 'admin'].forEach(x => { document.getElementById('tab-'+x).classList.toggle('hidden', x!==t); document.getElementById('btn-'+x).classList.toggle('tab-active', x===t); });
        }
        function hapusItem(i) { keranjang.splice(i, 1); renderKeranjang(); }
    </script>
</body>
</html>