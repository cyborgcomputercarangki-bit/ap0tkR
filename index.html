<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Apotek Reny - Professional POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .tab-active { color: #2563eb; border-bottom: 3px solid #2563eb; background: rgba(37, 99, 235, 0.05); }
        .hidden { display: none; }
        .autocomplete-items {
            position: absolute; border-radius: 1rem; max-height: 400px; overflow-y: auto;
            z-index: 100; top: 100%; left: 0; right: 0; background: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; margin-top: 5px;
        }
        .autocomplete-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        .autocomplete-item:hover { background: #f8fafc; }
        
        /* PERBAIKAN TAMPILAN TABEL MOBILE AGAR TIDAK MENUMPUK */
        @media (max-width: 640px) {
            .table-mobile thead { display: none; }
            .table-mobile tr { 
                display: block; 
                margin-bottom: 1rem; 
                background: white; 
                border-radius: 1rem; 
                padding: 12px; 
                border: 1px solid #e2e8f0;
            }
            .table-mobile td { 
                display: flex; 
                justify-content: space-between; 
                align-items: center;
                padding: 8px 4px; 
                border: none !important;
                text-align: right;
            }
            .table-mobile td::before { 
                content: attr(data-label); 
                font-weight: 800; 
                color: #64748b; 
                font-size: 10px; 
                text-transform: uppercase; 
                text-align: left;
                margin-right: 15px;
            }
            .item-list-wrap { max-width: 60%; line-height: 1.4; }
        }

        @media print {
            body * { visibility: hidden; }
            #receipt-print, #receipt-print * { visibility: visible; }
            #receipt-print { position: absolute; left: 0; top: 0; width: 80mm; font-family: monospace; font-size: 10pt; }
        }
    </style>
</head>
<body class="text-slate-800 pb-10">

    <header class="sticky top-0 z-50 glass border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-lg text-white">
                    <i class="fas fa-prescription-bottle-alt text-sm"></i>
                </div>
                <h1 class="text-base font-bold">Apotek Reny <span class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full ml-1 uppercase">Pro</span></h1>
            </div>
            <nav class="flex h-16">
                <button onclick="showTab('kasir')" id="btn-kasir" class="nav-btn px-4 font-bold text-slate-500 tab-active flex items-center gap-2">
                    <i class="fas fa-cash-register"></i> <span class="hidden md:inline">Kasir</span>
                </button>
                <button onclick="showTab('history')" id="btn-history" class="nav-btn px-4 font-bold text-slate-500 flex items-center gap-2">
                    <i class="fas fa-history"></i> <span class="hidden md:inline">Laporan</span>
                </button>
                <button onclick="showTab('admin')" id="btn-admin" class="nav-btn px-4 font-bold text-slate-500 flex items-center gap-2">
                    <i class="fas fa-tools"></i> <span class="hidden md:inline">Admin</span>
                </button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-6">
        
        <section id="tab-kasir" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-4">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-slate-700">Pencarian Cepat</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="relative">
                            <input id="input-search" type="text" placeholder="Ketik nama obat atau kategori..." 
                                class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 transition text-sm">
                            <div id="autocomplete-list" class="autocomplete-items hidden"></div>
                            <input type="hidden" id="selected-id">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Jumlah</label>
                                <input type="number" id="input-qty" value="1" min="1" inputmode="numeric" class="w-full mt-1 p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-center outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Jenis Penjualan</label>
                                <select id="input-satuan" class="w-full mt-1 p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-blue-600 outline-none appearance-none">
                                    <option value="box" selected>Grosir (Box/Pack)</option>
                                    <option value="biji">Eceran (Biji/Pcs)</option>
                                </select>
                            </div>
                        </div>
                        
                        <button onclick="tambahKeKeranjang()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-200 active:scale-[0.98] transition">
                            <i class="fas fa-plus mr-2"></i> Tambahkan ke Daftar
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-blue-100 sticky top-24">
                    <h2 class="font-bold mb-4 text-slate-700">Struk Belanja</h2>
                    <div id="list-keranjang" class="space-y-2 mb-6 max-h-[40vh] overflow-y-auto">
                        <p class="text-center text-slate-300 italic py-4 text-sm">Belum ada item</p>
                    </div>
                    
                    <div class="space-y-3 pt-4 border-t border-slate-100">
                        <div class="flex justify-between text-lg font-black text-slate-900">
                            <span>TOTAL</span>
                            <span id="total-harga" class="text-blue-600">Rp 0</span>
                        </div>
                        <input type="number" id="input-tunai" onkeyup="hitungKembalian()" inputmode="numeric" placeholder="Uang Tunai..." class="w-full p-4 bg-blue-50 border border-blue-100 rounded-2xl outline-none font-black text-xl text-blue-700 text-center">
                        <div class="flex justify-between items-center p-4 bg-slate-900 rounded-2xl text-white">
                            <span class="text-xs font-bold text-slate-400">KEMBALI</span>
                            <span id="text-kembalian" class="text-xl font-black text-emerald-400">Rp 0</span>
                        </div>
                        <button onclick="prosesCheckout()" class="w-full bg-emerald-500 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-[0.98] transition">
                            SIMPAN & CETAK STRUK
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-history" class="tab-content hidden space-y-6">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-black text-slate-800">Laporan Penjualan</h2>
                    <p class="text-slate-500 text-sm">Pantau performa apotek secara real-time</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-blue-500">
                    <div class="flex items-center gap-4 mb-2">
                        <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center"><i class="fas fa-calendar-day"></i></div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Hari Ini</p>
                    </div>
                    <h3 id="stat-hari" class="text-2xl font-black text-slate-800">Rp 0</h3>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-emerald-500">
                    <div class="flex items-center gap-4 mb-2">
                        <div class="w-10 h-10 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center"><i class="fas fa-calendar-alt"></i></div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Bulan Ini</p>
                    </div>
                    <h3 id="stat-bulan" class="text-2xl font-black text-slate-800">Rp 0</h3>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-orange-500">
                    <div class="flex items-center gap-4 mb-2">
                        <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center"><i class="fas fa-chart-line"></i></div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Tahun Ini</p>
                    </div>
                    <h3 id="stat-tahun" class="text-2xl font-black text-slate-800">Rp 0</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                    <div class="p-5 border-b border-slate-100 bg-blue-50/50"><h3 class="font-bold text-blue-800 text-sm italic uppercase">Rekap Harian</h3></div>
                    <div class="max-h-64 overflow-y-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-50 sticky top-0 font-bold text-slate-400 uppercase border-b">
                                <tr><th class="p-3">Tanggal</th><th class="p-3 text-right">Total</th></tr>
                            </thead>
                            <tbody id="tabel-rekap-harian" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="p-5 border-b border-slate-100 bg-emerald-50/50"><h3 class="font-bold text-emerald-800 text-sm italic uppercase">Rekap Bulanan</h3></div>
                        <div class="max-h-32 overflow-y-auto text-xs"><table class="w-full text-left"><tbody id="tabel-rekap-bulanan" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="p-5 border-b border-slate-100 bg-orange-50/50"><h3 class="font-bold text-orange-800 text-sm italic uppercase">Rekap Tahunan</h3></div>
                        <div class="max-h-32 overflow-y-auto text-xs"><table class="w-full text-left"><tbody id="tabel-rekap-tahunan" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                <div class="p-5 border-b border-slate-100"><h3 class="font-bold text-slate-700 text-sm">Riwayat Transaksi Terakhir</h3></div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm table-mobile">
                        <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase border-b">
                            <tr>
                                <th class="p-5">Waktu</th>
                                <th class="p-5">Invoice</th>
                                <th class="p-5">Rincian Obat</th>
                                <th class="p-5 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-history" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="tab-admin" class="tab-content hidden space-y-6">
            <div id="admin-auth" class="max-w-md mx-auto bg-white p-8 rounded-3xl shadow-xl text-center border mt-10">
                <i class="fas fa-user-lock text-4xl text-red-500 mb-4"></i>
                <h2 class="text-xl font-bold mb-6">Akses Terbatas</h2>
                <input type="password" id="admin-pass" placeholder="Password Admin" class="w-full p-4 bg-slate-50 border rounded-2xl mb-4 text-center outline-none">
                <button onclick="loginAdmin()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">Buka Database</button>
            </div>

            <div id="admin-content" class="hidden space-y-6">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-bold text-slate-700">Manajemen Obat & Expired</h2>
                        <button onclick="logoutAdmin()" class="text-xs text-red-500 font-bold uppercase">Logout</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        <input type="text" id="admin-nama" placeholder="Nama Obat" class="p-4 bg-slate-50 border rounded-2xl outline-none text-sm">
                        <input type="number" id="admin-harga-biji" placeholder="Ecer" class="p-4 bg-slate-50 border rounded-2xl outline-none text-sm">
                        <input type="number" id="admin-harga-box" placeholder="Box" class="p-4 bg-slate-50 border rounded-2xl outline-none text-sm">
                        <input type="number" id="admin-stok" placeholder="Stok" class="p-4 bg-slate-50 border rounded-2xl outline-none text-sm">
                        <div class="flex flex-col">
                            <label class="text-[9px] font-bold text-slate-400 ml-1">TGL EXPIRED</label>
                            <input type="date" id="admin-expired" class="p-3 bg-slate-50 border rounded-2xl outline-none text-sm">
                        </div>
                    </div>
                    <button onclick="updateDataObat()" class="w-full mt-4 bg-blue-600 text-white py-4 rounded-2xl font-bold">Simpan ke Sistem</button>
                </div>

                <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                    <table class="w-full text-left table-mobile">
                        <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase">
                            <tr><th class="p-4">Produk</th><th class="p-4">Harga</th><th class="p-4 text-center">Stok</th><th class="p-4">Expired</th><th class="p-4 text-right">Aksi</th></tr>
                        </thead>
                        <tbody id="tabel-stok" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="receipt-print" class="hidden"></div>

    <script>
        const MASTER_PASS = "reny123";
        const firebaseConfig = {
            apiKey: "AIzaSyCfi8bqVns9WvdrbTMVcJkYcKn-w1lX-Go",
            authDomain: "ap0tik-reny.firebaseapp.com",
            projectId: "ap0tik-reny",
            databaseURL: "https://ap0tik-reny-default-rtdb.asia-southeast1.firebasedatabase.app/", 
            storageBucket: "ap0tik-reny.firebasestorage.app",
            messagingSenderId: "463406659344",
            appId: "1:463406659344:web:27bd0a3b1bb884432b5795"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let dataObatGlobal = {};
        let keranjang = [];
        let totalTagihan = 0;

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('tab-active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('btn-' + id).classList.add('tab-active');
        }

        db.ref('obat').on('value', (s) => { if(s.exists()) { dataObatGlobal = s.val(); renderAdminTable(); } });
        db.ref('history').on('value', (s) => { 
            const val = s.val() || {};
            renderHistory(val); 
            calculateStats(val); 
            renderAllRekap(val);
        });

        const inpSearch = document.getElementById('input-search');
        const listSearch = document.getElementById('autocomplete-list');

        function renderSearch() {
            const v = inpSearch.value.toLowerCase();
            listSearch.innerHTML = '';
            if(v.length < 1 && document.activeElement !== inpSearch) return;

            Object.keys(dataObatGlobal).forEach(k => {
                const it = dataObatGlobal[k];
                if(it.nama.toLowerCase().includes(v)) {
                    const d = document.createElement('div');
                    d.className = 'autocomplete-item';
                    
                    const expDate = it.expired ? new Date(it.expired) : null;
                    const diffDays = expDate ? Math.ceil((expDate - new Date()) / (1000 * 60 * 60 * 24)) : null;
                    let expBadge = `<span class="text-[9px] text-slate-400">Exp: ${it.expired || '-'}</span>`;
                    if(diffDays !== null) {
                        if(diffDays < 0) expBadge = `<span class="text-[9px] text-white bg-red-600 px-1 rounded">EXPIRED!</span>`;
                        else if(diffDays < 90) expBadge = `<span class="text-[9px] text-white bg-orange-500 px-1 rounded font-bold">Hampir Exp</span>`;
                    }

                    d.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-bold text-slate-700 text-sm">${it.nama}</div>
                                <div class="flex gap-2 items-center">
                                    <span class="text-[9px] ${it.stok < 10 ? 'text-red-500' : 'text-blue-500'} font-bold">Stok: ${it.stok}</span>
                                    ${expBadge}
                                </div>
                            </div>
                            <div class="text-[10px] text-right">Rp${it.harga_biji.toLocaleString()} / pcs</div>
                        </div>`;
                    d.onclick = () => {
                        inpSearch.value = it.nama;
                        document.getElementById('selected-id').value = k;
                        listSearch.classList.add('hidden');
                    };
                    listSearch.appendChild(d);
                }
            });
            listSearch.classList.remove('hidden');
        }

        inpSearch.addEventListener('input', renderSearch);
        inpSearch.addEventListener('focus', renderSearch);
        document.addEventListener('click', (e) => { if(e.target !== inpSearch) setTimeout(()=>listSearch.classList.add('hidden'), 200); });

        function tambahKeKeranjang() {
            const id = document.getElementById('selected-id').value;
            const qty = parseInt(document.getElementById('input-qty').value);
            const satuan = document.getElementById('input-satuan').value;
            if(!id) return alert("Pilih obat dulu!");
            const it = dataObatGlobal[id];
            const harga = (satuan === 'biji') ? it.harga_biji : it.harga_box;
            const expVal = it.expired || ""; 

            keranjang.push({ id: id, nama: it.nama, qty: qty, satuan: satuan, harga: harga, expired: expVal, subtotal: harga * qty });
            renderKeranjang();
            inpSearch.value = ''; document.getElementById('selected-id').value = '';
        }

        function renderKeranjang() {
            const b = document.getElementById('list-keranjang');
            b.innerHTML = ''; totalTagihan = 0;
            if(keranjang.length === 0) b.innerHTML = '<p class="text-center text-slate-300 italic py-4">Belum ada item</p>';
            keranjang.forEach((it, i) => {
                totalTagihan += it.subtotal;
                b.innerHTML += `
                    <div class="bg-slate-50 p-3 rounded-2xl flex justify-between items-center text-xs border border-slate-100">
                        <div>
                            <div class="font-bold">${it.nama}</div>
                            <div class="text-[9px] text-slate-400">Exp: ${it.expired || '-'}</div>
                            <div class="text-blue-500 font-bold">${it.qty} ${it.satuan} @${it.harga.toLocaleString()}</div>
                        </div>
                        <div class="flex items-center gap-3 font-bold text-slate-700">Rp${it.subtotal.toLocaleString()} <button onclick="hapusItem(${i})" class="text-red-300"><i class="fas fa-times-circle"></i></button></div>
                    </div>`;
            });
            document.getElementById('total-harga').innerText = "Rp " + totalTagihan.toLocaleString();
            hitungKembalian();
        }

        function hapusItem(index) { keranjang.splice(index, 1); renderKeranjang(); }
        function hitungKembalian() {
            const t = parseInt(document.getElementById('input-tunai').value) || 0;
            const k = t - totalTagihan;
            document.getElementById('text-kembalian').innerText = "Rp " + (k < 0 ? 0 : k).toLocaleString();
        }

        async function prosesCheckout() {
            if(keranjang.length === 0) return;
            const tunai = parseInt(document.getElementById('input-tunai').value) || 0;
            if(tunai < totalTagihan) return alert("Uang tunai tidak cukup!");
            const n = new Date();
            const up = {};
            const inv = 'INV-' + n.getTime();
            const h = { invoice: inv, timestamp: n.getTime(), tanggal: n.toISOString().split('T')[0], bulan: n.toISOString().substring(0,7), tahun: n.toISOString().substring(0,4), items: keranjang, total: totalTagihan, tunai, kembali: tunai - totalTagihan };
            keranjang.forEach(it => { up[`/obat/${it.id}/stok`] = (dataObatGlobal[it.id].stok || 0) - it.qty; });
            try {
                await db.ref().update(up);
                await db.ref('history').push(h);
                cetakStruk(h);
                alert("Berhasil!");
                keranjang = []; document.getElementById('input-tunai').value = ''; renderKeranjang();
            } catch(e) { alert("Gagal: " + e.message); }
        }

        function cetakStruk(data) {
            const printArea = document.getElementById('receipt-print');
            let itemHtml = '';
            data.items.forEach(it => { itemHtml += `<div>${it.nama.substring(0,25)}<br>${it.qty} x ${it.harga.toLocaleString()} = ${it.subtotal.toLocaleString()}</div><br>`; });
            printArea.innerHTML = `<div style="text-align:center"><b>APOTEK RENY</b><br>---<br>ID: ${data.invoice}<br>Tgl: ${new Date(data.timestamp).toLocaleString('id-ID')}<br>---<br></div>${itemHtml}---<br><b>TOTAL: Rp ${data.total.toLocaleString()}</b><br>TUNAI: Rp ${data.tunai.toLocaleString()}<br>---<br><div style="text-align:center">Lekas Sembuh</div>`;
            window.print();
        }

        function calculateStats(h) {
            const n = new Date().toISOString();
            const hI = n.split('T')[0], bI = hI.substring(0,7), tI = hI.substring(0,4);
            let th=0, tb=0, tt=0;
            Object.values(h).forEach(d => {
                if(d.tanggal === hI) th += d.total;
                if(d.bulan === bI) tb += d.total;
                if(d.tahun === tI) tt += d.total;
            });
            document.getElementById('stat-hari').innerText = "Rp " + th.toLocaleString();
            document.getElementById('stat-bulan').innerText = "Rp " + tb.toLocaleString();
            document.getElementById('stat-tahun').innerText = "Rp " + tt.toLocaleString();
        }

        function renderAllRekap(h) {
            const trHarian = document.getElementById('tabel-rekap-harian');
            const trBulanan = document.getElementById('tabel-rekap-bulanan');
            const trTahunan = document.getElementById('tabel-rekap-tahunan');
            trHarian.innerHTML = ''; trBulanan.innerHTML = ''; trTahunan.innerHTML = '';
            const rekapHarian = {}, rekapBulanan = {}, rekapTahunan = {};
            Object.values(h).forEach(d => {
                rekapHarian[d.tanggal] = (rekapHarian[d.tanggal] || 0) + d.total;
                rekapBulanan[d.bulan] = (rekapBulanan[d.bulan] || 0) + d.total;
                rekapTahunan[d.tahun] = (rekapTahunan[d.tahun] || 0) + d.total;
            });
            Object.keys(rekapHarian).sort().reverse().forEach(tgl => {
                trHarian.innerHTML += `<tr><td class="p-3 font-bold">${tgl}</td><td class="p-3 text-right font-black text-blue-600">Rp ${rekapHarian[tgl].toLocaleString()}</td></tr>`;
            });
            Object.keys(rekapBulanan).sort().reverse().forEach(bln => {
                trBulanan.innerHTML += `<tr class="hover:bg-emerald-50"><td class="p-3 font-bold">${bln}</td><td class="p-3 text-right font-black text-emerald-600">Rp ${rekapBulanan[bln].toLocaleString()}</td></tr>`;
            });
            Object.keys(rekapTahunan).sort().reverse().forEach(thn => {
                trTahunan.innerHTML += `<tr class="hover:bg-orange-50"><td class="p-3 font-bold">${thn}</td><td class="p-3 text-right font-black text-orange-600">Rp ${rekapTahunan[thn].toLocaleString()}</td></tr>`;
            });
        }

        // FUNGSI RENDER HISTORY YANG SUDAH DIRAPIKAN AGAR TIDAK MENUMPUK
        function renderHistory(h) {
            const tb = document.getElementById('tabel-history');
            tb.innerHTML = '';
            const sortedHistory = Object.keys(h).map(key => ({...h[key], firebaseKey: key}))
                .sort((a, b) => b.timestamp - a.timestamp);

            sortedHistory.forEach(d => {
                const jam = new Date(d.timestamp).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                const r = d.items.map(i => `<span class="bg-slate-100 px-2 py-0.5 rounded text-[11px] font-semibold">${i.nama} (${i.qty})</span>`).join(' ');
                
                tb.innerHTML += `
                    <tr>
                        <td class="p-5" data-label="Waktu">
                            <div class="text-xs font-bold">${d.tanggal}</div>
                            <div class="text-[10px] text-slate-400">${jam}</div>
                        </td>
                        <td class="p-5" data-label="Invoice">
                            <span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded font-mono">${d.invoice}</span>
                        </td>
                        <td class="p-5" data-label="Obat">
                            <div class="item-list-wrap flex flex-wrap gap-1">${r}</div>
                        </td>
                        <td class="p-5 text-right" data-label="Total">
                            <div class="font-black text-slate-900 text-sm">Rp ${d.total.toLocaleString()}</div>
                        </td>
                    </tr>`;
            });
        }

        function loginAdmin() {
            if(document.getElementById('admin-pass').value === MASTER_PASS) {
                document.getElementById('admin-auth').classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
            } else alert("Salah!");
        }
        function logoutAdmin() {
            document.getElementById('admin-auth').classList.remove('hidden');
            document.getElementById('admin-content').classList.add('hidden');
        }

        async function updateDataObat() {
            const nama = document.getElementById('admin-nama').value;
            const hb = parseInt(document.getElementById('admin-harga-biji').value);
            const hbx = parseInt(document.getElementById('admin-harga-box').value) || 0;
            const stok = parseInt(document.getElementById('admin-stok').value) || 0;
            const exp = document.getElementById('admin-expired').value || "";
            if(!nama || isNaN(hb)) return alert("Nama & Harga Biji wajib!");
            const id = nama.toLowerCase().replace(/\s+/g, '-');
            await db.ref('obat/' + id).set({ nama, harga_biji: hb, harga_box: hbx, stok, expired: exp });
            alert("Tersimpan!");
            ['admin-nama', 'admin-harga-biji', 'admin-harga-box', 'admin-stok', 'admin-expired'].forEach(id => document.getElementById(id).value = '');
        }

        function renderAdminTable() {
            const tb = document.getElementById('tabel-stok');
            tb.innerHTML = '';
            Object.keys(dataObatGlobal).forEach(k => {
                const it = dataObatGlobal[k];
                tb.innerHTML += `
                    <tr>
                        <td class="p-4 font-bold" data-label="Produk">${it.nama}</td>
                        <td class="p-4" data-label="Harga">Ecer: ${it.harga_biji}<br>Box: ${it.harga_box}</td>
                        <td class="p-4 text-center font-bold" data-label="Stok">${it.stok}</td>
                        <td class="p-4" data-label="Exp">${it.expired || '-'}</td>
                        <td class="p-4 text-right">
                            <button onclick="editAdmin('${k}')" class="text-blue-500 mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="db.ref('obat/${k}').remove()" class="text-red-500"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        function editAdmin(id) {
            const it = dataObatGlobal[id];
            document.getElementById('admin-nama').value = it.nama;
            document.getElementById('admin-harga-biji').value = it.harga_biji;
            document.getElementById('admin-harga-box').value = it.harga_box;
            document.getElementById('admin-stok').value = it.stok;
            document.getElementById('admin-expired').value = it.expired || '';
            window.scrollTo(0,0);
        }
    </script>
</body>
</html>
